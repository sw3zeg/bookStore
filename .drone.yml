kind: pipeline
type: docker
name: default

steps:
  - name: build
    image: docker
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - docker build -t bookstore-app .

  - name: run
    image: docker/compose:1.29.2
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - docker-compose up -d --build

  - name: run load testing metrics plugin
    image: docker
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - docker run -v /drone/src:/k6 --privileged      -e SUBSCRIBE_TELEGRAM=true      -e TELEGRAM_TOKEN=8060387975:AAGTxAHHqHZo7LKpD4z7aLKx7LEZSngh8k8     -e TELEGRAM_CHAT_ID=958007638      -e SENDING_FORMAT=TEXT_FORMAT      -e ONLY_CURRENT_TEST=false      swezeg/loadtestingmetricsplugin:latest

volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock
