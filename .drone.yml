kind: pipeline
type: docker
name: default

workspace:
  path: /drone/src

steps:
  - name: cleanup docker state
    image: docker
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - docker-compose down -v || true
      - docker container prune -f || true
      - docker image prune -f || true

  - name: build bookstore app
    image: docker
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - docker build -t bookstore-app .

  - name: run bookstore API
    image: docker/compose:1.29.2
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - docker-compose up -d --build

  - name: run load testing metrics plugin
    image: docker
    privileged: true
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - ls -la /drone/src
      - ls -la /drone/src/k6
      - ls -la
      - pwd
      - docker pull swezeg/loadtestingmetricsplugin:latest
      - docker run --rm -v ./k6:/k6 -v /var/run/docker.sock:/var/run/docker.sock --privileged -e SUBSCRIBE_TELEGRAM="true" -e TELEGRAM_TOKEN="8060387975:AAGTxAHHqHZo7LKpD4z7aLKx7LEZSngh8k8" -e TELEGRAM_CHAT_ID="958007638" -e SENDING_FORMAT="TEXT_FORMAT" -e ONLY_CURRENT_TEST="true" swezeg/loadtestingmetricsplugin:latest

volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock
